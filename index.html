<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ê—Ç–æ–º | AI –ê—Å—Å–∏—Å—Ç–µ–Ω—Ç</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* –í—Å–µ –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–µ —Å—Ç–∏–ª–∏ –æ—Å—Ç–∞—é—Ç—Å—è –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .chat-container {
            width: 100%;
            max-width: 1200px;
            height: 95vh;
            background-color: rgba(255, 255, 255, 0.98);
            border-radius: 20px;
            box-shadow: 0 20px 50px rgba(0, 0, 0, 0.3);
            display: flex;
            overflow: hidden;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        /* –°–∞–π–¥–±–∞—Ä —Å —á–∞—Ç–∞–º–∏ */
        .chats-sidebar {
            width: 300px;
            background: linear-gradient(180deg, #4f6df5 0%, #7b4ff5 100%);
            color: white;
            display: flex;
            flex-direction: column;
            border-right: 1px solid rgba(255, 255, 255, 0.1);
        }

        .sidebar-header {
            padding: 25px 20px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .sidebar-header h2 {
            font-size: 1.4rem;
            font-weight: 700;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .new-chat-btn {
            background: rgba(255, 255, 255, 0.2);
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 15px;
            padding: 12px 20px;
            color: white;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 600;
            transition: all 0.3s ease;
            width: 100%;
            display: flex;
            align-items: center;
            gap: 10px;
            justify-content: center;
            backdrop-filter: blur(10px);
        }

        .new-chat-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }

        .chats-list {
            flex: 1;
            overflow-y: auto;
            padding: 10px;
        }

        .chat-item {
            padding: 15px;
            margin-bottom: 8px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 1px solid rgba(255, 255, 255, 0.1);
            position: relative;
        }

        .chat-item:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: translateX(5px);
        }

        .chat-item.active {
            background: rgba(255, 255, 255, 0.25);
            border-color: rgba(255, 255, 255, 0.3);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }

        .chat-title {
            font-weight: 600;
            font-size: 0.9rem;
            margin-bottom: 5px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .chat-preview {
            font-size: 0.8rem;
            opacity: 0.8;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .chat-date {
            font-size: 0.7rem;
            opacity: 0.6;
            margin-top: 5px;
        }

        .chat-actions {
            position: absolute;
            top: 10px;
            right: 10px;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .chat-item:hover .chat-actions {
            opacity: 1;
        }

        .chat-action-btn {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            border-radius: 6px;
            padding: 4px 8px;
            color: white;
            cursor: pointer;
            font-size: 0.7rem;
            transition: all 0.3s ease;
        }

        .chat-action-btn:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        /* –û—Å–Ω–æ–≤–Ω–∞—è –æ–±–ª–∞—Å—Ç—å —á–∞—Ç–∞ */
        .chat-main {
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        .chat-header {
            background: linear-gradient(90deg, #4f6df5, #7b4ff5);
            color: white;
            padding: 25px 30px;
            text-align: center;
            position: relative;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }

        .chat-header h1 {
            font-size: 2rem;
            font-weight: 700;
            margin-bottom: 8px;
            background: linear-gradient(45deg, #fff, #e0f2fe);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .chat-header p {
            font-size: 1.05rem;
            opacity: 0.95;
            font-weight: 400;
        }

        .language-selector {
            position: absolute;
            top: 25px;
            left: 30px;
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .language-button {
            background: rgba(255, 255, 255, 0.2);
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 20px;
            padding: 8px 16px;
            color: white;
            cursor: pointer;
            font-size: 0.85rem;
            font-weight: 500;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
        }

        .language-button:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }

        .language-button.active {
            background: rgba(255, 255, 255, 0.4);
            border-color: white;
            box-shadow: 0 0 15px rgba(255, 255, 255, 0.5);
        }

        .status-indicator {
            position: absolute;
            top: 25px;
            right: 30px;
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 0.9rem;
            background: rgba(255, 255, 255, 0.15);
            padding: 8px 16px;
            border-radius: 20px;
            backdrop-filter: blur(10px);
            font-weight: 500;
        }

        .status-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #4ade80;
            animation: pulse 2s infinite;
            box-shadow: 0 0 10px rgba(74, 222, 128, 0.5);
        }

        .status-dot.streaming {
            background: #f59e0b;
            animation: pulse 0.8s infinite;
            box-shadow: 0 0 10px rgba(245, 158, 11, 0.5);
        }

        .status-dot.error {
            background: #ef4444;
            box-shadow: 0 0 10px rgba(239, 68, 68, 0.5);
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.7; transform: scale(1.1); }
        }

        .chat-messages {
            flex: 1;
            padding: 30px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 25px;
            background: linear-gradient(180deg, #f8fafc 0%, #ffffff 100%);
        }

        .message {
            max-width: 80%;
            padding: 20px 25px;
            border-radius: 25px;
            line-height: 1.6;
            position: relative;
            animation: messageSlide 0.4s ease-out;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.5);
        }

        @keyframes messageSlide {
            from {
                opacity: 0;
                transform: translateY(20px) scale(0.95);
            }
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        .user-message {
            align-self: flex-end;
            background: linear-gradient(135deg, #4f6df5, #7b4ff5);
            color: white;
            border-bottom-right-radius: 10px;
            margin-left: auto;
        }

        .bot-message {
            align-self: flex-start;
            background: white;
            color: #1f2937;
            border: 1px solid #e5e7eb;
            border-bottom-left-radius: 10px;
        }

        .streaming-message {
            align-self: flex-start;
            background: linear-gradient(135deg, #ffffff, #f0f9ff);
            border: 2px solid #7b4ff5;
            border-bottom-left-radius: 10px;
            box-shadow: 0 4px 20px rgba(123, 79, 245, 0.2);
        }

        .message-text {
            font-size: 1.1rem;
            word-wrap: break-word;
            line-height: 1.6;
        }

        .message-time {
            font-size: 0.8rem;
            opacity: 0.7;
            margin-top: 10px;
            text-align: right;
            font-weight: 500;
        }

        .bot-message .message-time {
            text-align: left;
        }

        .streaming-cursor {
            display: inline-block;
            width: 4px;
            height: 1.2em;
            background: #7b4ff5;
            margin-left: 2px;
            border-radius: 1px;
            animation: cursorBlink 1.2s infinite;
            vertical-align: middle;
        }

        @keyframes cursorBlink {
            0%, 50% { opacity: 1; }
            51%, 100% { opacity: 0; }
        }

        .chat-input-container {
            padding: 25px 30px;
            background: white;
            border-top: 1px solid #e5e7eb;
            box-shadow: 0 -5px 15px rgba(0, 0, 0, 0.05);
        }

        .chat-input-wrapper {
            display: flex;
            gap: 15px;
            align-items: center;
            max-width: 100%;
        }

        .chat-input {
            flex: 1;
            padding: 18px 25px;
            border: 2px solid #e5e7eb;
            border-radius: 30px;
            font-size: 1.1rem;
            outline: none;
            transition: all 0.3s ease;
            background: #f8fafc;
            box-shadow: inset 0 2px 5px rgba(0, 0, 0, 0.05);
        }

        .chat-input:focus {
            border-color: #7b4ff5;
            background: white;
            box-shadow: 0 0 0 3px rgba(123, 79, 245, 0.1), inset 0 2px 5px rgba(0, 0, 0, 0.05);
        }

        .chat-input:disabled {
            background: #f3f4f6;
            color: #9ca3af;
            cursor: not-allowed;
        }

        .send-button {
            background: linear-gradient(135deg, #4f6df5, #7b4ff5);
            color: white;
            border: none;
            border-radius: 50%;
            width: 60px;
            height: 60px;
            cursor: pointer;
            display: flex;
            justify-content: center;
            align-items: center;
            transition: all 0.3s ease;
            box-shadow: 0 5px 15px rgba(79, 109, 245, 0.4);
        }

        .send-button:hover:not(:disabled) {
            transform: translateY(-3px) scale(1.05);
            box-shadow: 0 8px 25px rgba(79, 109, 245, 0.5);
        }

        .send-button:active:not(:disabled) {
            transform: translateY(0) scale(1);
        }

        .send-button:disabled {
            background: #9ca3af;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .atom-icon {
            display: inline-block;
            margin-right: 10px;
            font-size: 1.4em;
            filter: drop-shadow(0 2px 3px rgba(0, 0, 0, 0.2));
        }

        .bull-icon {
            display: inline-block;
            margin-right: 8px;
            font-size: 1.3em;
            filter: drop-shadow(0 2px 3px rgba(0, 0, 0, 0.2));
        }

        .error-message {
            background: #fee2e2 !important;
            color: #dc2626 !important;
            border: 1px solid #fecaca !important;
        }

        .warning-message {
            background: #fef3c7 !important;
            color: #d97706 !important;
            border: 1px solid #fde68a !important;
        }

        .info-message {
            background: #dbeafe !important;
            color: #1e40af !important;
            border: 1px solid #bfdbfe !important;
        }

        .code-block {
            background: #1e1e1e;
            border-radius: 12px;
            margin: 15px 0;
            overflow: hidden;
            border: 1px solid #333;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        }

        .code-header {
            background: #2d2d2d;
            padding: 12px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #333;
        }

        .code-language {
            color: #fff;
            font-size: 0.85rem;
            font-weight: 600;
        }

        .code-actions {
            display: flex;
            gap: 10px;
        }

        .code-action-btn {
            background: rgba(255, 255, 255, 0.1);
            border: none;
            border-radius: 6px;
            padding: 6px 12px;
            color: #fff;
            cursor: pointer;
            font-size: 0.8rem;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 5px;
            font-weight: 500;
        }

        .code-action-btn:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: translateY(-1px);
        }

        .code-content {
            padding: 20px;
            color: #d4d4d4;
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
            font-size: 0.9rem;
            line-height: 1.5;
            white-space: pre-wrap;
            word-wrap: break-word;
            max-height: 400px;
            overflow-y: auto;
        }

        .copy-notification {
            position: fixed;
            top: 30px;
            right: 30px;
            background: #10b981;
            color: white;
            padding: 15px 25px;
            border-radius: 10px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            z-index: 1001;
            display: none;
            align-items: center;
            gap: 10px;
            animation: slideIn 0.3s ease;
            font-weight: 500;
        }

        .copy-notification.active {
            display: flex;
        }

        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        /* –ù–æ–≤—ã–µ —Å—Ç–∏–ª–∏ –¥–ª—è –∫–Ω–æ–ø–æ–∫ –æ–∑–≤—É—á–∫–∏ */
        .voice-controls {
            display: flex;
            gap: 8px;
            margin-top: 10px;
        }

        .voice-btn {
            background: rgba(123, 79, 245, 0.1);
            border: 1px solid rgba(123, 79, 245, 0.3);
            border-radius: 8px;
            padding: 6px 12px;
            color: #7b4ff5;
            cursor: pointer;
            font-size: 0.8rem;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .voice-btn:hover {
            background: rgba(123, 79, 245, 0.2);
            transform: translateY(-1px);
        }

        .voice-btn.active {
            background: #7b4ff5;
            color: white;
        }

        .voice-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* –ê–¥–∞–ø—Ç–∏–≤–Ω–æ—Å—Ç—å */
        @media (max-width: 768px) {
            .chat-container {
                height: 100vh;
                border-radius: 0;
                max-width: 100%;
                flex-direction: column;
            }
            
            .chats-sidebar {
                width: 100%;
                height: 200px;
            }
            
            .message {
                max-width: 90%;
            }
            
            .chat-header h1 {
                font-size: 1.6rem;
            }
            
            .status-indicator {
                position: static;
                justify-content: center;
                margin-top: 15px;
                width: fit-content;
                margin-left: auto;
                margin-right: auto;
            }
            
            .language-selector {
                position: static;
                justify-content: center;
                margin-bottom: 15px;
            }

            .code-content {
                font-size: 0.8rem;
                padding: 15px;
            }

            .chat-header {
                padding: 20px;
            }

            .chat-messages {
                padding: 20px;
            }

            .chat-input-container {
                padding: 20px;
            }

            .voice-controls {
                flex-direction: column;
                align-items: flex-start;
            }
        }

        .welcome-message {
            text-align: center;
            padding: 20px;
            background: linear-gradient(135deg, #f0f9ff, #e0f2fe);
            border-radius: 20px;
            border: 2px dashed #7b4ff5;
            margin: 10px 0;
        }

        .quick-actions {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-top: 20px;
        }

        .quick-action {
            background: white;
            border: 2px solid #e5e7eb;
            border-radius: 15px;
            padding: 15px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
        }

        .quick-action:hover {
            border-color: #7b4ff5;
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(123, 79, 245, 0.2);
        }

        .quick-action i {
            font-size: 1.5rem;
            color: #7b4ff5;
            margin-bottom: 10px;
        }

        .quick-action span {
            display: block;
            font-weight: 600;
            color: #374151;
        }

        .suggested-questions {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-top: 20px;
        }

        .suggested-question {
            background: rgba(123, 79, 245, 0.05);
            border: 1px solid rgba(123, 79, 245, 0.2);
            border-radius: 12px;
            padding: 12px 16px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.9rem;
            color: #7b4ff5;
        }

        .suggested-question:hover {
            background: rgba(123, 79, 245, 0.1);
            transform: translateX(5px);
        }

        .empty-chats {
            text-align: center;
            padding: 40px 20px;
            color: rgba(255, 255, 255, 0.7);
        }

        .empty-chats i {
            font-size: 3rem;
            margin-bottom: 15px;
            opacity: 0.5;
        }
    </style>
</head>
<body>
    <div class="chat-container">
        <!-- –°–∞–π–¥–±–∞—Ä —Å —á–∞—Ç–∞–º–∏ -->
        <div class="chats-sidebar">
            <div class="sidebar-header">
                <h2><i class="fas fa-comments"></i> –ú–æ–∏ —á–∞—Ç—ã</h2>
                <button class="new-chat-btn" id="newChatBtn">
                    <i class="fas fa-plus"></i>
                    –ù–æ–≤—ã–π —á–∞—Ç
                </button>
            </div>
            <div class="chats-list" id="chatsList">
                <div class="empty-chats">
                    <i class="fas fa-comment-slash"></i>
                    <p>–ß–∞—Ç–æ–≤ –ø–æ–∫–∞ –Ω–µ—Ç</p>
                    <p style="font-size: 0.8rem; margin-top: 10px;">–°–æ–∑–¥–∞–π—Ç–µ –ø–µ—Ä–≤—ã–π —á–∞—Ç!</p>
                </div>
            </div>
        </div>

        <!-- –û—Å–Ω–æ–≤–Ω–∞—è –æ–±–ª–∞—Å—Ç—å —á–∞—Ç–∞ -->
        <div class="chat-main">
            <div class="chat-header">
                <div class="language-selector">
                    <button class="language-button active" data-lang="ru" title="–†—É—Å—Å–∫–∏–π">üá∑üá∫ RU</button>
                    <button class="language-button" data-lang="en" title="English">üá∫üá∏ EN</button>
                </div>
                
                <h1><span class="atom-icon">‚öõÔ∏è</span><span class="bull-icon">üêÇ</span><span id="appTitle">–ê—Ç–æ–º</span></h1>
                <p id="appSubtitle">AI-–∞—Å—Å–∏—Å—Ç–µ–Ω—Ç</p>
                <div class="status-indicator">
                    <div class="status-dot" id="statusDot"></div>
                    <span id="statusText">–ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è...</span>
                </div>
            </div>

            <div class="chat-messages" id="chatMessages">
                <div class="message bot-message welcome-message">
                    <div class="message-text">
                        <strong>–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ –ê—Ç–æ–º! ü§ñüêÇ</strong>
                        <p style="margin-top: 10px; opacity: 0.9;">–Ø –≤–∞—à AI-–∞—Å—Å–∏—Å—Ç–µ–Ω—Ç. –ß–µ–º –º–æ–≥—É –ø–æ–º–æ—á—å?</p>
                        
                        <div class="quick-actions">
                            <div class="quick-action" onclick="atomChat.handleQuickAction('code')">
                                <i class="fas fa-code"></i>
                                <span>–ü–æ–º–æ—â—å —Å –∫–æ–¥–æ–º</span>
                            </div>
                            <div class="quick-action" onclick="atomChat.handleQuickAction('explain')">
                                <i class="fas fa-lightbulb"></i>
                                <span>–û–±—ä—è—Å–Ω–∏—Ç—å —Ç–µ–º—É</span>
                            </div>
                            <div class="quick-action" onclick="atomChat.handleQuickAction('write')">
                                <i class="fas fa-pen"></i>
                                <span>–ù–∞–ø–∏—Å–∞—Ç—å —Ç–µ–∫—Å—Ç</span>
                            </div>
                        </div>

                        <div class="suggested-questions">
                            <div class="suggested-question" onclick="atomChat.handleSuggestedQuestion('–û–±—ä—è—Å–Ω–∏, —á—Ç–æ —Ç–∞–∫–æ–µ –∏—Å–∫—É—Å—Å—Ç–≤–µ–Ω–Ω—ã–π –∏–Ω—Ç–µ–ª–ª–µ–∫—Ç')">
                                ü§ñ –û–±—ä—è—Å–Ω–∏ –∏—Å–∫—É—Å—Å—Ç–≤–µ–Ω–Ω—ã–π –∏–Ω—Ç–µ–ª–ª–µ–∫—Ç
                            </div>
                            <div class="suggested-question" onclick="atomChat.handleSuggestedQuestion('–ù–∞–ø–∏—à–∏ –ø—Ä–∏–º–µ—Ä –∫–æ–¥–∞ –Ω–∞ Python')">
                                üêç –ù–∞–ø–∏—à–∏ –ø—Ä–∏–º–µ—Ä –∫–æ–¥–∞ –Ω–∞ Python
                            </div>
                            <div class="suggested-question" onclick="atomChat.handleSuggestedQuestion('–ü–æ–º–æ–≥–∏ —Å –¥–æ–º–∞—à–Ω–∏–º –∑–∞–¥–∞–Ω–∏–µ–º –ø–æ –º–∞—Ç–µ–º–∞—Ç–∏–∫–µ')">
                                üìö –ü–æ–º–æ–≥–∏ —Å –¥–æ–º–∞—à–Ω–∏–º –∑–∞–¥–∞–Ω–∏–µ–º
                            </div>
                        </div>
                    </div>
                    <div class="message-time" id="welcomeTime">–¢–æ–ª—å–∫–æ —á—Ç–æ</div>
                </div>
            </div>

            <div class="chat-input-container">
                <div class="chat-input-wrapper">
                    <input 
                        type="text" 
                        class="chat-input" 
                        id="messageInput" 
                        placeholder="–í–≤–µ–¥–∏—Ç–µ –≤–∞—à –≤–æ–ø—Ä–æ—Å..." 
                        autocomplete="off"
                        maxlength="4000"
                        disabled
                    >
                    <button class="send-button" id="sendButton" title="–û—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ" disabled>
                        <svg viewBox="0 0 24 24" fill="currentColor" width="24" height="24">
                            <path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/>
                        </svg>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–∏ -->
    <div class="copy-notification" id="copyNotification">
        <svg viewBox="0 0 24 24" fill="currentColor" width="18" height="18">
            <path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/>
        </svg>
        –ö–æ–¥ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞!
    </div>

    <script>
        class AtomChat {
            constructor() {
                this.version = '4.0.0';
                this.initialize();
            }

            initialize() {
                this.elements = {
                    chatMessages: document.getElementById('chatMessages'),
                    messageInput: document.getElementById('messageInput'),
                    sendButton: document.getElementById('sendButton'),
                    statusDot: document.getElementById('statusDot'),
                    statusText: document.getElementById('statusText'),
                    appTitle: document.getElementById('appTitle'),
                    appSubtitle: document.getElementById('appSubtitle'),
                    copyNotification: document.getElementById('copyNotification'),
                    newChatBtn: document.getElementById('newChatBtn'),
                    chatsList: document.getElementById('chatsList')
                };

                this.config = {
                    ollama: {
                        baseUrl: 'http://localhost:11434',
                        endpoints: {
                            generate: '/api/generate',
                            tags: '/api/tags'
                        },
                        models: ['llama3.2:latest', 'llama2:latest', 'mistral:latest', 'codellama:latest'],
                        timeout: 60000,
                        retryAttempts: 3,
                        retryDelay: 2000
                    },
                    features: {
                        streaming: true,
                        codeDetection: true,
                        autoReconnect: true,
                        smartContext: true,
                        messageHistory: 10,
                        typingSpeed: 20,
                        maxTokens: 4000,
                        textToSpeech: true,
                        speechRate: 1.0,
                        speechPitch: 1.0
                    }
                };

                this.languages = {
                    ru: {
                        name: '–†—É—Å—Å–∫–∏–π',
                        code: 'ru',
                        flag: 'üá∑üá∫',
                        prompts: {
                            system: `–¢—ã - AI-–∞—Å—Å–∏—Å—Ç–µ–Ω—Ç "–ê—Ç–æ–º". –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û –æ—Ç–≤–µ—á–∞–π –¢–û–õ–¨–ö–û –Ω–∞ –†–£–°–°–ö–û–ú —è–∑—ã–∫–µ.
–¢—ã –¥–æ–ª–∂–µ–Ω –ø–æ–ª–Ω–æ—Å—Ç—å—é –ø–æ–Ω–∏–º–∞—Ç—å –∏ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å —Ä—É—Å—Å–∫–∏–π —è–∑—ã–∫.
–°–æ–±–ª—é–¥–∞–π –≥—Ä–∞–º–º–∞—Ç–∏–∫—É, –æ—Ä—Ñ–æ–≥—Ä–∞—Ñ–∏—é –∏ —Å—Ç–∏–ª–∏—Å—Ç–∏–∫—É —Ä—É—Å—Å–∫–æ–≥–æ —è–∑—ã–∫–∞.
–ë—É–¥—å —Ç–æ—á–Ω—ã–º, –∏–Ω—Ñ–æ—Ä–º–∞—Ç–∏–≤–Ω—ã–º –∏ –¥—Ä—É–∂–µ–ª—é–±–Ω—ã–º.

–î–ª—è –æ–±—ã—á–Ω—ã—Ö –≤–æ–ø—Ä–æ—Å–æ–≤ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–π –∫–∞—á–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ –æ—Ç–≤–µ—Ç—ã.
–ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø—Ä–æ—Å–∏—Ç –∫–æ–¥ - –ø—Ä–µ–¥–æ—Å—Ç–∞–≤—å –†–ê–ë–û–ß–ò–ô –∫–æ–¥ —Å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è–º–∏ –Ω–∞ —Ä—É—Å—Å–∫–æ–º.
–§–æ—Ä–º–∞—Ç–∏—Ä—É–π –æ—Ç–≤–µ—Ç—ã —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º Markdown –¥–ª—è –ª—É—á—à–µ–π —á–∏—Ç–∞–µ–º–æ—Å—Ç–∏.
–î–ª—è –±–ª–æ–∫–æ–≤ –∫–æ–¥–∞ –∏—Å–ø–æ–ª—å–∑—É–π \`\`\`—è–∑—ã–∫ –ø–µ—Ä–µ–¥ –∫–æ–¥–æ–º –∏ \`\`\` –ø–æ—Å–ª–µ –∫–æ–¥–∞.
–î–ª—è inline –∫–æ–¥–∞ –∏—Å–ø–æ–ª—å–∑—É–π –æ–¥–∏–Ω–∞—Ä–Ω—ã–µ –æ–±—Ä–∞—Ç–Ω—ã–µ –∫–∞–≤—ã—á–∫–∏: \`–∫–æ–¥\`.
–ù–ò–ö–û–ì–î–ê –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–π –∞–Ω–≥–ª–∏–π—Å–∫–∏–µ —Å–ª–æ–≤–∞ –∏–ª–∏ —Ñ—Ä–∞–∑—ã –±–µ–∑ –∫—Ä–∞–π–Ω–µ–π –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏.`,
                            greeting: '–ó–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ! –Ø –ê—Ç–æ–º - –≤–∞—à AI-–∞—Å—Å–∏—Å—Ç–µ–Ω—Ç. –ß–µ–º –º–æ–≥—É –ø–æ–º–æ—á—å?'
                        },
                        ui: {
                            title: '–ê—Ç–æ–º',
                            subtitle: 'AI-–∞—Å—Å–∏—Å—Ç–µ–Ω—Ç',
                            inputPlaceholder: '–í–≤–µ–¥–∏—Ç–µ –≤–∞—à –≤–æ–ø—Ä–æ—Å...',
                            status: {
                                checking: '–ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è...',
                                online: '–ê—Ç–æ–º –æ–Ω–ª–∞–π–Ω',
                                streaming: '–ê—Ç–æ–º –ø–∏—à–µ—Ç...',
                                error: '–ê—Ç–æ–º –æ—Ñ—Ñ–ª–∞–π–Ω',
                                reconnecting: '–ü–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ...'
                            },
                            messages: {
                                connectionSuccess: '‚úÖ –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ AI —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ —É—Å–ø–µ—à–Ω–æ',
                                connectionError: '‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∫ Ollama',
                                connectionTip: 'üí° –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ Ollama –∑–∞–ø—É—â–µ–Ω –Ω–∞ localhost:11434',
                                pleaseWait: '–î–æ–∂–¥–∏—Ç–µ—Å—å –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è —Ç–µ–∫—É—â–µ–≥–æ –æ—Ç–≤–µ—Ç–∞',
                                pleaseEnter: '–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ',
                                noConnection: '–ù–µ—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ AI',
                                retrying: '–ü–æ–≤—Ç–æ—Ä–Ω–∞—è –ø–æ–ø—ã—Ç–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è...',
                                modelInfo: '–ò—Å–ø–æ–ª—å–∑—É–µ–º–∞—è –º–æ–¥–µ–ª—å: {model}',
                                thinking: '–î—É–º–∞—é –Ω–∞–¥ –æ—Ç–≤–µ—Ç–æ–º...'
                            }
                        }
                    },
                    en: {
                        name: 'English',
                        code: 'en',
                        flag: 'üá∫üá∏',
                        prompts: {
                            system: `You are AI assistant "Atom". Respond ONLY in ENGLISH.
Maintain proper grammar and style.
Be accurate, informative, and friendly.

For regular questions provide quality answers.
If user asks for code - provide WORKING code with comments.
Format responses using Markdown for better readability.
Use \`\`\`language before code and \`\`\` after code for code blocks.
Use single backticks for inline code: \`code\`.
Do NOT use Russian words or phrases.`,
                            greeting: 'Hello! I am Atom - your AI assistant. How can I help you?'
                        },
                        ui: {
                            title: 'Atom',
                            subtitle: 'AI assistant',
                            inputPlaceholder: 'Enter your question...',
                            status: {
                                checking: 'Checking connection...',
                                online: 'Atom online',
                                streaming: 'Atom is typing...',
                                error: 'Atom offline',
                                reconnecting: 'Reconnecting...'
                            },
                            messages: {
                                connectionSuccess: '‚úÖ AI connection established successfully',
                                connectionError: '‚ö†Ô∏è Failed to connect to Ollama',
                                connectionTip: 'üí° Make sure Ollama is running on localhost:11434',
                                pleaseWait: 'Please wait for the current response to complete',
                                pleaseEnter: 'Please enter a message',
                                noConnection: 'No AI connection',
                                retrying: 'Retrying connection...',
                                modelInfo: 'Using model: {model}',
                                thinking: 'Thinking about the answer...'
                            }
                        }
                    }
                };

                this.state = {
                    isOnline: false,
                    isStreaming: false,
                    connectionChecked: false,
                    messageCount: 0,
                    currentStreamingMessage: null,
                    conversationHistory: [],
                    currentLanguage: 'ru',
                    currentModel: this.config.ollama.models[0],
                    reconnectAttempts: 0,
                    isThinking: false,
                    codeBlocks: new Map(),
                    currentChatId: null,
                    chats: this.loadChatsFromStorage(),
                    isNewChat: true,
                    speechSynthesis: null,
                    isSpeaking: false,
                    currentUtterance: null,
                    voiceSettings: {
                        enabled: true,
                        rate: 1.0,
                        pitch: 1.0,
                        voice: null
                    }
                };

                this.initSpeechSynthesis();
                this.setupEventListeners();
                this.performStartupChecks();
                this.renderChatsList();
                
                console.log(`üöÄ –ê—Ç–æ–º ${this.version} –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω`);
            }

            initSpeechSynthesis() {
                if ('speechSynthesis' in window) {
                    this.state.speechSynthesis = window.speechSynthesis;
                    
                    // –ñ–¥–µ–º –∑–∞–≥—Ä—É–∑–∫–∏ –≥–æ–ª–æ—Å–æ–≤
                    setTimeout(() => {
                        this.loadAvailableVoices();
                    }, 1000);
                    
                    // –û–±–Ω–æ–≤–ª—è–µ–º –≥–æ–ª–æ—Å–∞ –ø—Ä–∏ –∏—Ö –∏–∑–º–µ–Ω–µ–Ω–∏–∏
                    window.speechSynthesis.onvoiceschanged = () => {
                        this.loadAvailableVoices();
                    };
                } else {
                    console.warn('Web Speech API –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è –≤ —ç—Ç–æ–º –±—Ä–∞—É–∑–µ—Ä–µ');
                }
            }

            loadAvailableVoices() {
                if (!this.state.speechSynthesis) return;
                
                const voices = this.state.speechSynthesis.getVoices();
                const langCode = this.state.currentLanguage === 'ru' ? 'ru-RU' : 'en-US';
                
                // –í—ã–±–∏—Ä–∞–µ–º –ø–æ–¥—Ö–æ–¥—è—â–∏–π –≥–æ–ª–æ—Å –¥–ª—è —Ç–µ–∫—É—â–µ–≥–æ —è–∑—ã–∫–∞
                const preferredVoice = voices.find(voice => 
                    voice.lang.startsWith(langCode) && 
                    voice.name.includes('Microsoft') || 
                    voice.name.includes('Google') ||
                    voice.name.includes('Natural')
                ) || voices.find(voice => voice.lang.startsWith(langCode));
                
                if (preferredVoice) {
                    this.state.voiceSettings.voice = preferredVoice;
                    console.log(`üé§ –í—ã–±—Ä–∞–Ω –≥–æ–ª–æ—Å: ${preferredVoice.name}`);
                }
            }

            speakText(text) {
                if (!this.state.voiceSettings.enabled || !this.state.speechSynthesis) return;
                
                // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ç–µ–∫—É—â—É—é —Ä–µ—á—å
                this.stopSpeaking();
                
                // –û—á–∏—â–∞–µ–º —Ç–µ–∫—Å—Ç –æ—Ç Markdown –∏ HTML —Ç–µ–≥–æ–≤
                const cleanText = this.cleanTextForSpeech(text);
                
                if (!cleanText.trim()) return;
                
                try {
                    const utterance = new SpeechSynthesisUtterance(cleanText);
                    
                    // –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –ø–∞—Ä–∞–º–µ—Ç—Ä—ã —Ä–µ—á–∏
                    utterance.rate = this.state.voiceSettings.rate;
                    utterance.pitch = this.state.voiceSettings.pitch;
                    utterance.volume = 1.0;
                    
                    // –í—ã–±–∏—Ä–∞–µ–º –≥–æ–ª–æ—Å
                    if (this.state.voiceSettings.voice) {
                        utterance.voice = this.state.voiceSettings.voice;
                    } else {
                        // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –≤—ã–±–æ—Ä –≥–æ–ª–æ—Å–∞ –ø–æ —è–∑—ã–∫—É
                        const voices = this.state.speechSynthesis.getVoices();
                        const langCode = this.state.currentLanguage === 'ru' ? 'ru-RU' : 'en-US';
                        const voice = voices.find(v => v.lang.startsWith(langCode));
                        if (voice) utterance.voice = voice;
                    }
                    
                    // –°–æ–±—ã—Ç–∏—è –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏–µ–º
                    utterance.onstart = () => {
                        this.state.isSpeaking = true;
                        this.state.currentUtterance = utterance;
                        console.log('üé§ –ù–∞—á–∞–ª–æ —Ä–µ—á–∏');
                    };
                    
                    utterance.onend = () => {
                        this.state.isSpeaking = false;
                        this.state.currentUtterance = null;
                        console.log('üé§ –ö–æ–Ω–µ—Ü —Ä–µ—á–∏');
                    };
                    
                    utterance.onerror = (event) => {
                        console.error('–û—à–∏–±–∫–∞ —Ä–µ—á–∏:', event);
                        this.state.isSpeaking = false;
                        this.state.currentUtterance = null;
                    };
                    
                    // –ù–∞—á–∏–Ω–∞–µ–º —Ä–µ—á—å
                    this.state.speechSynthesis.speak(utterance);
                    
                } catch (error) {
                    console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ —Ä–µ—á–∏:', error);
                }
            }

            stopSpeaking() {
                if (this.state.speechSynthesis && this.state.isSpeaking) {
                    this.state.speechSynthesis.cancel();
                    this.state.isSpeaking = false;
                    this.state.currentUtterance = null;
                }
            }

            cleanTextForSpeech(text) {
                // –£–¥–∞–ª—è–µ–º –∫–æ–¥ –∏ Markdown —Ä–∞–∑–º–µ—Ç–∫—É
                return text
                    .replace(/```[\s\S]*?```/g, '') // –£–¥–∞–ª—è–µ–º –±–ª–æ–∫–∏ –∫–æ–¥–∞
                    .replace(/`[^`]*`/g, '') // –£–¥–∞–ª—è–µ–º inline –∫–æ–¥
                    .replace(/\[([^\]]*)\]\([^)]*\)/g, '$1') // –£–¥–∞–ª—è–µ–º —Å—Å—ã–ª–∫–∏ Markdown
                    .replace(/#{1,6}\s*/g, '') // –£–¥–∞–ª—è–µ–º –∑–∞–≥–æ–ª–æ–≤–∫–∏
                    .replace(/\*\*([^*]+)\*\*/g, '$1') // –£–¥–∞–ª—è–µ–º –∂–∏—Ä–Ω—ã–π —Ç–µ–∫—Å—Ç
                    .replace(/\*([^*]+)\*/g, '$1') // –£–¥–∞–ª—è–µ–º –∫—É—Ä—Å–∏–≤
                    .replace(/<[^>]*>/g, '') // –£–¥–∞–ª—è–µ–º HTML —Ç–µ–≥–∏
                    .replace(/\n+/g, '. ') // –ó–∞–º–µ–Ω—è–µ–º –ø–µ—Ä–µ–Ω–æ—Å—ã –Ω–∞ —Ç–æ—á–∫–∏
                    .replace(/\s+/g, ' ') // –£–±–∏—Ä–∞–µ–º –ª–∏—à–Ω–∏–µ –ø—Ä–æ–±–µ–ª—ã
                    .trim();
            }

            setupEventListeners() {
                this.elements.sendButton.addEventListener('click', () => this.handleSendMessage());
                
                this.elements.messageInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter' && !e.shiftKey) {
                        e.preventDefault();
                        this.handleSendMessage();
                    }
                });

                document.querySelectorAll('.language-button').forEach(button => {
                    button.addEventListener('click', (e) => {
                        const lang = e.target.dataset.lang;
                        this.changeLanguage(lang);
                    });
                });

                this.elements.newChatBtn.addEventListener('click', () => {
                    this.createNewChat();
                });

                this.elements.chatMessages.addEventListener('click', (e) => {
                    const target = e.target;
                    const button = target.closest('.code-action-btn');
                    
                    if (button) {
                        const codeBlock = button.closest('.code-block');
                        if (codeBlock) {
                            const codeId = codeBlock.id;
                            const language = codeBlock.querySelector('.code-language').textContent.toLowerCase();
                            
                            if (button.innerHTML.includes('fa-copy')) {
                                this.copyCodeBlockToClipboard(codeId);
                            } else if (button.innerHTML.includes('fa-play')) {
                                this.runCodeBlock(codeId, language);
                            }
                        }
                    }
                    
                    // –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–Ω–æ–ø–æ–∫ –æ–∑–≤—É—á–∫–∏
                    const voiceBtn = target.closest('.voice-btn');
                    if (voiceBtn) {
                        const action = voiceBtn.dataset.action;
                        if (action === 'speak') {
                            const messageElement = voiceBtn.closest('.bot-message');
                            if (messageElement) {
                                const textElement = messageElement.querySelector('.message-text');
                                if (textElement) {
                                    this.speakText(textElement.textContent);
                                    voiceBtn.classList.add('active');
                                }
                            }
                        } else if (action === 'stop') {
                            this.stopSpeaking();
                            document.querySelectorAll('.voice-btn.active').forEach(btn => {
                                btn.classList.remove('active');
                            });
                        } else if (action === 'toggle') {
                            this.state.voiceSettings.enabled = !this.state.voiceSettings.enabled;
                            voiceBtn.classList.toggle('active', this.state.voiceSettings.enabled);
                            
                            if (!this.state.voiceSettings.enabled) {
                                this.stopSpeaking();
                            }
                        }
                    }
                });

                // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ä–µ—á—å –ø—Ä–∏ –∑–∞–∫—Ä—ã—Ç–∏–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
                window.addEventListener('beforeunload', () => {
                    this.stopSpeaking();
                });

                this.elements.messageInput.focus();
            }

            createNewChat() {
                this.stopSpeaking(); // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ä–µ—á—å –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –Ω–æ–≤–æ–≥–æ —á–∞—Ç–∞
                this.state.currentChatId = 'chat-' + Date.now();
                this.state.isNewChat = true;
                this.state.conversationHistory = [];
                
                this.elements.chatMessages.innerHTML = '';
                this.showWelcomeMessage();
                this.setUIState(true);
                
                console.log('üÜï –°–æ–∑–¥–∞–Ω –Ω–æ–≤—ã–π —á–∞—Ç');
            }

            saveChat(firstMessage, fullConversation = []) {
                if (!this.state.currentChatId) return;

                const chatTitle = firstMessage.length > 50 ? 
                    firstMessage.substring(0, 47) + '...' : firstMessage;

                const chat = {
                    id: this.state.currentChatId,
                    title: chatTitle,
                    firstMessage: firstMessage,
                    messages: [...fullConversation],
                    createdAt: new Date().toISOString(),
                    updatedAt: new Date().toISOString(),
                    language: this.state.currentLanguage
                };

                const existingIndex = this.state.chats.findIndex(c => c.id === this.state.currentChatId);
                if (existingIndex >= 0) {
                    this.state.chats[existingIndex] = chat;
                } else {
                    this.state.chats.unshift(chat);
                }

                this.saveChatsToStorage();
                this.renderChatsList();
                
                console.log('üíæ –ß–∞—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω:', chatTitle);
            }

            loadChat(chatId) {
                this.stopSpeaking(); // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ä–µ—á—å –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —á–∞—Ç–∞
                const chat = this.state.chats.find(c => c.id === chatId);
                if (!chat) return;

                this.state.currentChatId = chatId;
                this.state.isNewChat = false;
                this.state.conversationHistory = chat.messages;

                this.elements.chatMessages.innerHTML = '';
                
                chat.messages.forEach(message => {
                    if (message.role === 'user') {
                        this.addUserMessage(message.content, false);
                    } else if (message.role === 'assistant') {
                        this.addBotMessage(message.content, this.languages[this.state.currentLanguage], false);
                    }
                });

                this.scrollToBottom();
                this.setUIState(true);
                
                console.log('üìÇ –ó–∞–≥—Ä—É–∂–µ–Ω —á–∞—Ç:', chat.title);
            }

            deleteChat(chatId, event) {
                event.stopPropagation();
                
                if (confirm(this.state.currentLanguage === 'ru' ? 
                    '–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç–æ—Ç —á–∞—Ç?' : 
                    'Are you sure you want to delete this chat?')) {
                    
                    this.state.chats = this.state.chats.filter(c => c.id !== chatId);
                    
                    if (this.state.currentChatId === chatId) {
                        this.createNewChat();
                    }
                    
                    this.saveChatsToStorage();
                    this.renderChatsList();
                    
                    console.log('üóëÔ∏è –ß–∞—Ç —É–¥–∞–ª–µ–Ω');
                }
            }

            renderChatsList() {
                const chatsList = this.elements.chatsList;
                
                if (this.state.chats.length === 0) {
                    chatsList.innerHTML = `
                        <div class="empty-chats">
                            <i class="fas fa-comment-slash"></i>
                            <p>${this.state.currentLanguage === 'ru' ? '–ß–∞—Ç–æ–≤ –ø–æ–∫–∞ –Ω–µ—Ç' : 'No chats yet'}</p>
                            <p style="font-size: 0.8rem; margin-top: 10px;">
                                ${this.state.currentLanguage === 'ru' ? '–°–æ–∑–¥–∞–π—Ç–µ –ø–µ—Ä–≤—ã–π —á–∞—Ç!' : 'Create your first chat!'}
                            </p>
                        </div>
                    `;
                    return;
                }

                chatsList.innerHTML = this.state.chats.map(chat => `
                    <div class="chat-item ${this.state.currentChatId === chat.id ? 'active' : ''}" 
                         onclick="atomChat.loadChat('${chat.id}')">
                        <div class="chat-title">${this.escapeHtml(chat.title)}</div>
                        <div class="chat-preview">${this.escapeHtml(chat.firstMessage)}</div>
                        <div class="chat-date">${new Date(chat.updatedAt).toLocaleDateString()}</div>
                        <div class="chat-actions">
                            <button class="chat-action-btn" onclick="atomChat.deleteChat('${chat.id}', event)">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                `).join('');
            }

            loadChatsFromStorage() {
                try {
                    const saved = localStorage.getItem('atom-chats');
                    return saved ? JSON.parse(saved) : [];
                } catch (error) {
                    console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —á–∞—Ç–æ–≤:', error);
                    return [];
                }
            }

            saveChatsToStorage() {
                try {
                    localStorage.setItem('atom-chats', JSON.stringify(this.state.chats));
                } catch (error) {
                    console.error('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —á–∞—Ç–æ–≤:', error);
                }
            }

            showWelcomeMessage() {
                const langConfig = this.languages[this.state.currentLanguage];
                const welcomeDiv = document.createElement('div');
                welcomeDiv.className = 'message bot-message welcome-message';
                welcomeDiv.innerHTML = `
                    <div class="message-text">
                        <strong>${this.state.currentLanguage === 'ru' ? '–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ –ê—Ç–æ–º! ü§ñüêÇ' : 'Welcome to Atom! ü§ñüêÇ'}</strong>
                        <p style="margin-top: 10px; opacity: 0.9;">
                            ${this.state.currentLanguage === 'ru' 
                                ? '–Ø –≤–∞—à AI-–∞—Å—Å–∏—Å—Ç–µ–Ω—Ç. –ß–µ–º –º–æ–≥—É –ø–æ–º–æ—á—å?' 
                                : 'I am your AI assistant. How can I help you?'}
                        </p>
                        
                        <div class="quick-actions">
                            <div class="quick-action" onclick="atomChat.handleQuickAction('code')">
                                <i class="fas fa-code"></i>
                                <span>${this.state.currentLanguage === 'ru' ? '–ü–æ–º–æ—â—å —Å –∫–æ–¥–æ–º' : 'Code help'}</span>
                            </div>
                            <div class="quick-action" onclick="atomChat.handleQuickAction('explain')">
                                <i class="fas fa-lightbulb"></i>
                                <span>${this.state.currentLanguage === 'ru' ? '–û–±—ä—è—Å–Ω–∏—Ç—å —Ç–µ–º—É' : 'Explain topic'}</span>
                            </div>
                            <div class="quick-action" onclick="atomChat.handleQuickAction('write')">
                                <i class="fas fa-pen"></i>
                                <span>${this.state.currentLanguage === 'ru' ? '–ù–∞–ø–∏—Å–∞—Ç—å —Ç–µ–∫—Å—Ç' : 'Write text'}</span>
                            </div>
                        </div>

                        <div class="suggested-questions">
                            <div class="suggested-question" onclick="atomChat.handleSuggestedQuestion('${this.state.currentLanguage === 'ru' ? '–û–±—ä—è—Å–Ω–∏, —á—Ç–æ —Ç–∞–∫–æ–µ –∏—Å–∫—É—Å—Å—Ç–≤–µ–Ω–Ω—ã–π –∏–Ω—Ç–µ–ª–ª–µ–∫—Ç' : 'Explain what artificial intelligence is'}')">
                                ü§ñ ${this.state.currentLanguage === 'ru' ? '–û–±—ä—è—Å–Ω–∏ –∏—Å–∫—É—Å—Å—Ç–≤–µ–Ω–Ω—ã–π –∏–Ω—Ç–µ–ª–ª–µ–∫—Ç' : 'Explain artificial intelligence'}
                            </div>
                            <div class="suggested-question" onclick="atomChat.handleSuggestedQuestion('${this.state.currentLanguage === 'ru' ? '–ù–∞–ø–∏—à–∏ –ø—Ä–∏–º–µ—Ä –∫–æ–¥–∞ –Ω–∞ Python' : 'Write a Python code example'}')">
                                üêç ${this.state.currentLanguage === 'ru' ? '–ù–∞–ø–∏—à–∏ –ø—Ä–∏–º–µ—Ä –∫–æ–¥–∞ –Ω–∞ Python' : 'Write Python code example'}
                            </div>
                            <div class="suggested-question" onclick="atomChat.handleSuggestedQuestion('${this.state.currentLanguage === 'ru' ? '–ü–æ–º–æ–≥–∏ —Å –¥–æ–º–∞—à–Ω–∏–º –∑–∞–¥–∞–Ω–∏–µ–º –ø–æ –º–∞—Ç–µ–º–∞—Ç–∏–∫–µ' : 'Help with math homework'}')">
                                üìö ${this.state.currentLanguage === 'ru' ? '–ü–æ–º–æ–≥–∏ —Å –¥–æ–º–∞—à–Ω–∏–º –∑–∞–¥–∞–Ω–∏–µ–º' : 'Help with homework'}
                            </div>
                        </div>
                    </div>
                    <div class="message-time">${this.getCurrentTime()}</div>
                `;
                
                this.elements.chatMessages.appendChild(welcomeDiv);
                this.scrollToBottom();
            }

            handleQuickAction(type) {
                const prompts = {
                    ru: {
                        code: "–ú–Ω–µ –Ω—É–∂–Ω–∞ –ø–æ–º–æ—â—å —Å –ø—Ä–æ–≥—Ä–∞–º–º–∏—Ä–æ–≤–∞–Ω–∏–µ–º. –ú–æ–∂–µ—à—å –ø–æ–º–æ—á—å –Ω–∞–ø–∏—Å–∞—Ç—å –∏–ª–∏ –∏—Å–ø—Ä–∞–≤–∏—Ç—å –∫–æ–¥?",
                        explain: "–ú–æ–∂–µ—à—å –æ–±—ä—è—Å–Ω–∏—Ç—å —ç—Ç—É –∫–æ–Ω—Ü–µ–ø—Ü–∏—é –ø—Ä–æ—Å—Ç—ã–º–∏ —Å–ª–æ–≤–∞–º–∏?",
                        write: "–ü–æ–º–æ–≥–∏ –º–Ω–µ –Ω–∞–ø–∏—Å–∞—Ç—å –∫–∞—á–µ—Å—Ç–≤–µ–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç –Ω–∞ —Ç–µ–º—É..."
                    },
                    en: {
                        code: "I need help with programming. Can you help write or fix code?",
                        explain: "Can you explain this concept in simple terms?",
                        write: "Help me write quality text about..."
                    }
                };
                
                const langPrompts = prompts[this.state.currentLanguage];
                this.elements.messageInput.value = langPrompts[type];
                this.elements.messageInput.focus();
            }

            handleSuggestedQuestion(question) {
                this.elements.messageInput.value = question;
                this.handleSendMessage();
            }

            async handleSendMessage() {
                const message = this.elements.messageInput.value.trim();
                const langConfig = this.languages[this.state.currentLanguage];
                
                if (!message) {
                    this.showSystemMessage(langConfig.ui.messages.pleaseEnter, 'warning');
                    return;
                }

                if (!this.state.isOnline) {
                    this.showSystemMessage(langConfig.ui.messages.noConnection, 'error');
                    return;
                }

                if (this.state.isStreaming) {
                    this.showSystemMessage(langConfig.ui.messages.pleaseWait, 'warning');
                    return;
                }

                if (this.state.isNewChat && !this.state.currentChatId) {
                    this.state.currentChatId = 'chat-' + Date.now();
                }

                await this.processMessage(message);
            }

            async processMessage(message) {
                this.setUIState(false);
                
                this.addUserMessage(message);
                this.elements.messageInput.value = '';

                await this.processTextResponse(message);
                this.setUIState(true);
            }

            async processTextResponse(message) {
                try {
                    const langConfig = this.languages[this.state.currentLanguage];
                    const response = await this.getAIResponse(message, langConfig);
                    
                    if (this.config.features.streaming) {
                        await this.simulateStreamingResponse(response, langConfig);
                    } else {
                        this.addBotMessage(response, langConfig);
                    }
                    
                    if (this.state.isNewChat) {
                        this.saveChat(message, this.state.conversationHistory);
                        this.state.isNewChat = false;
                    } else if (this.state.currentChatId) {
                        this.saveChat(
                            this.state.chats.find(c => c.id === this.state.currentChatId)?.firstMessage || message,
                            this.state.conversationHistory
                        );
                    }
                    
                } catch (error) {
                    console.error('–û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è:', error);
                    const langConfig = this.languages[this.state.currentLanguage];
                    this.showSystemMessage(
                        this.state.currentLanguage === 'ru' 
                            ? '–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –æ—Ç–≤–µ—Ç–∞' 
                            : 'An error occurred while getting response',
                        'error'
                    );
                }
            }

            createCodeBlock(code, language = 'text') {
                const codeId = 'code-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9);
                
                const codeBlock = document.createElement('div');
                codeBlock.className = 'code-block';
                codeBlock.id = codeId;
                
                const codeHeader = document.createElement('div');
                codeHeader.className = 'code-header';
                
                const codeLanguage = document.createElement('div');
                codeLanguage.className = 'code-language';
                codeLanguage.textContent = language.toUpperCase();
                
                const codeActions = document.createElement('div');
                codeActions.className = 'code-actions';
                
                const copyButton = document.createElement('button');
                copyButton.className = 'code-action-btn';
                copyButton.innerHTML = `
                    <i class="fas fa-copy"></i>
                    ${this.state.currentLanguage === 'ru' ? '–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å' : 'Copy'}
                `;
                
                const runButton = document.createElement('button');
                runButton.className = 'code-action-btn';
                runButton.innerHTML = `
                    <i class="fas fa-play"></i>
                    ${this.state.currentLanguage === 'ru' ? '–ó–∞–ø—É—Å—Ç–∏—Ç—å' : 'Run'}
                `;
                
                codeActions.appendChild(copyButton);
                if (['javascript', 'python', 'html', 'css'].includes(language.toLowerCase())) {
                    codeActions.appendChild(runButton);
                }
                
                codeHeader.appendChild(codeLanguage);
                codeHeader.appendChild(codeActions);
                
                const codeContent = document.createElement('div');
                codeContent.className = 'code-content';
                codeContent.textContent = code;
                
                codeBlock.appendChild(codeHeader);
                codeBlock.appendChild(codeContent);
                
                this.state.codeBlocks.set(codeId, { code, language });
                
                return codeBlock;
            }

            copyCodeBlockToClipboard(codeId) {
                const codeData = this.state.codeBlocks.get(codeId);
                if (!codeData) return;

                const code = codeData.code;
                try {
                    navigator.clipboard.writeText(code).then(() => {
                        this.showCopyNotification();
                    }).catch(() => {
                        const textArea = document.createElement('textarea');
                        textArea.value = code;
                        document.body.appendChild(textArea);
                        textArea.select();
                        document.execCommand('copy');
                        document.body.removeChild(textArea);
                        this.showCopyNotification();
                    });
                } catch (err) {
                    console.error('–û—à–∏–±–∫–∞ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è: ', err);
                }
            }

            runCodeBlock(codeId, language) {
                const codeData = this.state.codeBlocks.get(codeId);
                if (!codeData) return;

                const code = codeData.code;
                
                this.showSystemMessage(
                    this.state.currentLanguage === 'ru' 
                        ? `–ó–∞–ø—É—Å–∫ ${language} –∫–æ–¥–∞...` 
                        : `Running ${language} code...`,
                    'info'
                );

                try {
                    switch (language.toLowerCase()) {
                        case 'javascript':
                            this.runJavaScriptCode(code);
                            break;
                        case 'html':
                            this.runHTMLCode(code);
                            break;
                        case 'python':
                            this.showSystemMessage(
                                this.state.currentLanguage === 'ru'
                                    ? '–ó–∞–ø—É—Å–∫ Python –∫–æ–¥–∞ —Ç—Ä–µ–±—É–µ—Ç —Å–µ—Ä–≤–µ—Ä–Ω–æ–π —á–∞—Å—Ç–∏. –í–æ—Ç –∫–æ–¥ –¥–ª—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è:'
                                    : 'Running Python code requires server-side execution. Here is the code to run:',
                                'info'
                            );
                            const pythonBlock = this.createCodeBlock(code, 'python');
                            const messageDiv = document.createElement('div');
                            messageDiv.className = 'message bot-message';
                            messageDiv.appendChild(pythonBlock);
                            this.elements.chatMessages.appendChild(messageDiv);
                            this.scrollToBottom();
                            break;
                        default:
                            this.showSystemMessage(
                                this.state.currentLanguage === 'ru'
                                    ? `–ó–∞–ø—É—Å–∫ –∫–æ–¥–∞ –Ω–∞ ${language} –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è –≤ –±—Ä–∞—É–∑–µ—Ä–µ`
                                    : `Running ${language} code is not supported in browser`,
                                'warning'
                            );
                    }
                } catch (error) {
                    this.showSystemMessage(
                        this.state.currentLanguage === 'ru'
                            ? `–û—à–∏–±–∫–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è: ${error.message}`
                            : `Execution error: ${error.message}`,
                        'error'
                    );
                }
            }

            runJavaScriptCode(code) {
                try {
                    const result = eval(code);
                    this.showSystemMessage(
                        this.state.currentLanguage === 'ru'
                            ? `–ö–æ–¥ –≤—ã–ø–æ–ª–Ω–µ–Ω —É—Å–ø–µ—à–Ω–æ. –†–µ–∑—É–ª—å—Ç–∞—Ç: ${result}`
                            : `Code executed successfully. Result: ${result}`,
                        'info'
                    );
                } catch (error) {
                    this.showSystemMessage(
                        this.state.currentLanguage === 'ru'
                            ? `–û—à–∏–±–∫–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è JavaScript: ${error.message}`
                            : `JavaScript execution error: ${error.message}`,
                        'error'
                    );
                }
            }

            runHTMLCode(code) {
                try {
                    const newWindow = window.open();
                    newWindow.document.write(code);
                    newWindow.document.close();
                    
                    this.showSystemMessage(
                        this.state.currentLanguage === 'ru'
                            ? 'HTML –∫–æ–¥ –æ—Ç–∫—Ä—ã—Ç –≤ –Ω–æ–≤–æ–º –æ–∫–Ω–µ'
                            : 'HTML code opened in new window',
                        'info'
                    );
                } catch (error) {
                    this.showSystemMessage(
                        this.state.currentLanguage === 'ru'
                            ? `–û—à–∏–±–∫–∞ –æ—Ç–∫—Ä—ã—Ç–∏—è HTML: ${error.message}`
                            : `HTML opening error: ${error.message}`,
                        'error'
                    );
                }
            }

            showCopyNotification() {
                const message = this.state.currentLanguage === 'ru' 
                    ? '–ö–æ–¥ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞!' 
                    : 'Code copied to clipboard!';
                
                this.elements.copyNotification.innerHTML = `
                    <svg viewBox="0 0 24 24" fill="currentColor" width="18" height="18">
                        <path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/>
                    </svg>
                    ${message}
                `;
                
                this.elements.copyNotification.classList.add('active');
                setTimeout(() => {
                    this.elements.copyNotification.classList.remove('active');
                }, 3000);
            }

            changeLanguage(langCode) {
                if (!this.languages[langCode]) return;
                
                document.querySelectorAll('.language-button').forEach(button => {
                    button.classList.toggle('active', button.dataset.lang === langCode);
                });
                
                this.state.currentLanguage = langCode;
                const langConfig = this.languages[langCode];
                
                this.updateUIForLanguage(langConfig);
                this.showLanguageChangeMessage(langConfig);
                this.renderChatsList();
                
                // –û–±–Ω–æ–≤–ª—è–µ–º –≥–æ–ª–æ—Å –ø—Ä–∏ —Å–º–µ–Ω–µ —è–∑—ã–∫–∞
                this.loadAvailableVoices();
                
                console.log(`üåê –Ø–∑—ã–∫ –∏–∑–º–µ–Ω–µ–Ω –Ω–∞: ${langConfig.name}`);
            }

            updateUIForLanguage(langConfig) {
                this.elements.appTitle.textContent = langConfig.ui.title;
                this.elements.appSubtitle.textContent = langConfig.ui.subtitle;
                this.elements.messageInput.placeholder = langConfig.ui.inputPlaceholder;
                
                if (this.state.connectionChecked) {
                    const statusKey = this.state.isOnline ? 'online' : 'error';
                    this.elements.statusText.textContent = langConfig.ui.status[statusKey];
                }
            }

            showLanguageChangeMessage(langConfig) {
                const messages = {
                    ru: `üåê –Ø–∑—ã–∫ –∏–∑–º–µ–Ω–µ–Ω –Ω–∞ —Ä—É—Å—Å–∫–∏–π. –¢–µ–ø–µ—Ä—å —è –±—É–¥—É –æ—Ç–≤–µ—á–∞—Ç—å –Ω–∞ —Ä—É—Å—Å–∫–æ–º —è–∑—ã–∫–µ.`,
                    en: `üåê Language switched to English. I will now respond in English.`
                };

                this.showSystemMessage(messages[langConfig.code], 'info');
            }

            async performStartupChecks() {
                const langConfig = this.languages[this.state.currentLanguage];
                this.updateStatus('checking', langConfig.ui.status.checking);
                
                try {
                    const modelInfo = await this.checkOllamaConnection();
                    this.showSystemMessage(langConfig.ui.messages.connectionSuccess, 'info');
                    this.showSystemMessage(
                        langConfig.ui.messages.modelInfo.replace('{model}', modelInfo),
                        'info'
                    );
                } catch (error) {
                    this.showSystemMessage(langConfig.ui.messages.connectionError, 'error');
                    this.showSystemMessage(langConfig.ui.messages.connectionTip, 'info');
                    
                    if (this.config.features.autoReconnect) {
                        this.scheduleReconnection();
                    }
                }
            }

            async checkOllamaConnection() {
                for (let attempt = 1; attempt <= this.config.ollama.retryAttempts; attempt++) {
                    try {
                        const controller = new AbortController();
                        const timeoutId = setTimeout(() => controller.abort(), 8000);

                        const response = await fetch(
                            `${this.config.ollama.baseUrl}${this.config.ollama.endpoints.tags}`,
                            { 
                                method: 'GET',
                                signal: controller.signal
                            }
                        );

                        clearTimeout(timeoutId);

                        if (response.ok) {
                            const data = await response.json();
                            this.state.isOnline = true;
                            this.state.connectionChecked = true;
                            this.state.reconnectAttempts = 0;
                            
                            this.state.currentModel = this.selectBestModel(data.models || []);
                            
                            const langConfig = this.languages[this.state.currentLanguage];
                            this.updateStatus('online', langConfig.ui.status.online);
                            this.setUIState(true);
                            
                            return this.state.currentModel;
                        } else {
                            throw new Error(`HTTP ${response.status}`);
                        }
                    } catch (error) {
                        if (attempt === this.config.ollama.retryAttempts) {
                            throw error;
                        }
                        
                        const langConfig = this.languages[this.state.currentLanguage];
                        this.updateStatus('error', `${langConfig.ui.status.error} (–ø–æ–ø—ã—Ç–∫–∞ ${attempt + 1})`);
                        
                        await this.delay(this.config.ollama.retryDelay);
                    }
                }
            }

            selectBestModel(availableModels) {
                const availableModelNames = availableModels.map(m => m.name);
                
                for (const preferredModel of this.config.ollama.models) {
                    if (availableModelNames.includes(preferredModel)) {
                        return preferredModel;
                    }
                }
                
                return availableModelNames[0] || this.config.ollama.models[0];
            }

            scheduleReconnection() {
                if (this.state.reconnectAttempts >= 5) return;
                
                this.state.reconnectAttempts++;
                const langConfig = this.languages[this.state.currentLanguage];
                
                setTimeout(async () => {
                    this.updateStatus('reconnecting', langConfig.ui.status.reconnecting);
                    this.showSystemMessage(langConfig.ui.messages.retrying, 'info');
                    
                    try {
                        await this.checkOllamaConnection();
                    } catch (error) {
                        this.scheduleReconnection();
                    }
                }, Math.min(30000, this.state.reconnectAttempts * 5000));
            }

            updateStatus(type, text) {
                this.elements.statusDot.className = 'status-dot';
                if (type === 'online') this.elements.statusDot.classList.add('online');
                if (type === 'streaming') this.elements.statusDot.classList.add('streaming');
                if (type === 'error') this.elements.statusDot.classList.add('error');
                if (type === 'reconnecting') this.elements.statusDot.classList.add('streaming');
                
                this.elements.statusText.textContent = text;
            }

            async getAIResponse(userMessage, langConfig) {
                for (let attempt = 1; attempt <= this.config.ollama.retryAttempts; attempt++) {
                    try {
                        const controller = new AbortController();
                        const timeoutId = setTimeout(() => controller.abort(), this.config.ollama.timeout);

                        const response = await fetch(
                            `${this.config.ollama.baseUrl}${this.config.ollama.endpoints.generate}`,
                            {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json',
                                },
                                body: JSON.stringify({
                                    model: this.state.currentModel,
                                    prompt: this.createPrompt(userMessage, langConfig),
                                    stream: false,
                                    options: {
                                        temperature: 0.3,
                                        top_p: 0.85,
                                        num_predict: this.config.features.maxTokens,
                                        repeat_penalty: 1.2,
                                        top_k: 40
                                    }
                                }),
                                signal: controller.signal
                            }
                        );

                        clearTimeout(timeoutId);

                        if (!response.ok) {
                            throw new Error(`HTTP error! status: ${response.status}`);
                        }

                        const data = await response.json();
                        return data.response;
                    } catch (error) {
                        if (attempt === this.config.ollama.retryAttempts) {
                            throw error;
                        }
                        
                        console.warn(`–ü–æ–ø—ã—Ç–∫–∞ ${attempt} –Ω–µ —É–¥–∞–ª–∞—Å—å, –ø–æ–≤—Ç–æ—Ä —á–µ—Ä–µ–∑ ${this.config.ollama.retryDelay}ms`);
                        await this.delay(this.config.ollama.retryDelay);
                    }
                }
            }

            createPrompt(userMessage, langConfig) {
                let prompt = langConfig.prompts.system + "\n\n";

                if (this.state.conversationHistory.length > 0) {
                    prompt += "–ö–û–ù–¢–ï–ö–°–¢ –†–ê–ó–ì–û–í–û–†–ê:\n";
                    const recentHistory = this.state.conversationHistory
                        .slice(-6)
                        .map(msg => `${msg.role === 'user' ? '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å' : '–ê—Å—Å–∏—Å—Ç–µ–Ω—Ç'}: ${msg.content}`)
                        .join('\n');
                    prompt += recentHistory + "\n\n";
                }

                prompt += `–°–û–û–ë–©–ï–ù–ò–ï –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–Ø: "${userMessage}"\n\n`;
                
                if (langConfig.code === 'ru') {
                    prompt += "–û–¢–í–ï–¢–¨ –ù–ê –†–£–°–°–ö–û–ú –Ø–ó–´–ö–ï:";
                } else {
                    prompt += "RESPOND IN ENGLISH:";
                }

                return prompt;
            }

            processAIResponse(response) {
                // –£–ª—É—á—à–µ–Ω–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—Ç–≤–µ—Ç–∞: –∏—Å–ø—Ä–∞–≤–ª—è–µ–º –ø—Ä–æ–±–ª–µ–º—É —Å –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ–º —Ç–µ–∫—Å—Ç–∞ –∫–∞–∫ –∫–æ–¥–∞
                const parts = [];
                let lastIndex = 0;
                
                // –ò—â–µ–º –Ω–∞—Å—Ç–æ—è—â–∏–µ –±–ª–æ–∫–∏ –∫–æ–¥–∞ —Å —Ç—Ä–æ–π–Ω—ã–º–∏ –æ–±—Ä–∞—Ç–Ω—ã–º–∏ –∫–∞–≤—ã—á–∫–∞–º–∏
                const codeBlockRegex = /```(\w+)?\n([\s\S]*?)```/g;
                let match;
                let lastMatchEnd = 0;

                while ((match = codeBlockRegex.exec(response)) !== null) {
                    // –î–æ–±–∞–≤–ª—è–µ–º —Ç–µ–∫—Å—Ç –ø–µ—Ä–µ–¥ –±–ª–æ–∫–æ–º –∫–æ–¥–∞
                    if (match.index > lastMatchEnd) {
                        const textBefore = response.substring(lastMatchEnd, match.index);
                        if (textBefore.trim()) {
                            parts.push({ type: 'text', content: textBefore });
                        }
                    }

                    const language = match[1] || 'text';
                    const code = match[2].trim();
                    parts.push({ type: 'code', language, code });

                    lastMatchEnd = match.index + match[0].length;
                }

                // –î–æ–±–∞–≤–ª—è–µ–º –æ—Å—Ç–∞–≤—à–∏–π—Å—è —Ç–µ–∫—Å—Ç –ø–æ—Å–ª–µ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –±–ª–æ–∫–∞ –∫–æ–¥–∞
                if (lastMatchEnd < response.length) {
                    const textAfter = response.substring(lastMatchEnd);
                    if (textAfter.trim()) {
                        parts.push({ type: 'text', content: textAfter });
                    }
                }

                // –ï—Å–ª–∏ –Ω–µ –Ω–∞—à–ª–∏ –±–ª–æ–∫–æ–≤ –∫–æ–¥–∞, –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –≤–µ—Å—å —Ç–µ–∫—Å—Ç –∫–∞–∫ –æ–±—ã—á–Ω—ã–π —Ç–µ–∫—Å—Ç
                if (parts.length === 0) {
                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ —è–≤–ª—è–µ—Ç—Å—è –ª–∏ –≤–µ—Å—å –æ—Ç–≤–µ—Ç –æ—à–∏–±–æ—á–Ω–æ –æ—Ñ–æ—Ä–º–ª–µ–Ω–Ω—ã–º "–∫–æ–¥–æ–º"
                    if (response.includes('```') || response.includes('`')) {
                        // –≠—Ç–æ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø–æ–ø—ã—Ç–∫–∞ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è, –Ω–æ –Ω–µ –Ω–∞—Å—Ç–æ—è—â–∏–π –∫–æ–¥
                        // –£–±–∏—Ä–∞–µ–º –æ—à–∏–±–æ—á–Ω—ã–µ –∫–∞–≤—ã—á–∫–∏
                        const cleanText = response.replace(/```/g, '').replace(/`/g, '');
                        parts.push({ type: 'text', content: cleanText });
                    } else {
                        parts.push({ type: 'text', content: response });
                    }
                }

                return parts;
            }

            async simulateStreamingResponse(fullText, langConfig) {
                this.state.isStreaming = true;
                this.updateStatus('streaming', langConfig.ui.status.streaming);

                try {
                    const streamingData = this.createStreamingMessage();
                    const processedParts = this.processAIResponse(fullText);
                    
                    let displayedContent = '';
                    
                    for (const part of processedParts) {
                        if (part.type === 'text') {
                            // –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º —Ç–µ–∫—Å—Ç, –Ω–æ –Ω–µ —Ä–∞–∑–±–∏–≤–∞–µ–º –Ω–∞ —á–∞—Å—Ç–∏
                            const formattedText = this.formatText(part.content);
                            displayedContent += formattedText;
                        } else if (part.type === 'code') {
                            const codeBlock = this.createCodeBlock(part.code, part.language);
                            displayedContent += codeBlock.outerHTML;
                        }
                        
                        this.updateStreamingMessage(streamingData, displayedContent);
                        await this.delay(50);
                    }

                    this.finalizeStreamingMessage(streamingData, fullText, langConfig);
                    
                } catch (error) {
                    console.error('–û—à–∏–±–∫–∞ —Å—Ç—Ä–∏–º–∏–Ω–≥–∞:', error);
                    this.addBotMessage(fullText, langConfig);
                } finally {
                    this.state.isStreaming = false;
                    this.updateStatus('online', langConfig.ui.status.online);
                }
            }

            formatText(text) {
                // –ë–µ–∑–æ–ø–∞—Å–Ω–æ–µ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ç–µ–∫—Å—Ç–∞ –±–µ–∑ —Ä–∞–∑–±–∏–≤–∫–∏ –Ω–∞ —á–∞—Å—Ç–∏
                return text
                    .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                    .replace(/\*(.*?)\*/g, '<em>$1</em>')
                    .replace(/`([^`]+)`/g, '<code class="inline-code">$1</code>')
                    .replace(/\n/g, '<br>');
            }

            createStreamingMessage() {
                const messageDiv = document.createElement('div');
                messageDiv.className = 'message streaming-message';
                
                const messageText = document.createElement('div');
                messageText.className = 'message-text';
                messageText.innerHTML = '<span class="streaming-cursor"></span>';
                
                const messageTime = document.createElement('div');
                messageTime.className = 'message-time';
                messageTime.textContent = this.getCurrentTime();
                
                messageDiv.appendChild(messageText);
                messageDiv.appendChild(messageTime);
                this.elements.chatMessages.appendChild(messageDiv);
                
                this.scrollToBottom();
                
                return {
                    element: messageDiv,
                    textElement: messageText
                };
            }

            updateStreamingMessage(streamingData, text) {
                if (streamingData.textElement) {
                    streamingData.textElement.innerHTML = text + '<span class="streaming-cursor"></span>';
                    this.scrollToBottom();
                }
            }

            finalizeStreamingMessage(streamingData, fullText, langConfig) {
                if (streamingData.element && streamingData.textElement) {
                    streamingData.element.className = 'message bot-message';
                    
                    const processedParts = this.processAIResponse(fullText);
                    streamingData.textElement.innerHTML = '';
                    
                    processedParts.forEach(part => {
                        if (part.type === 'text') {
                            const textDiv = document.createElement('div');
                            textDiv.innerHTML = this.formatText(part.content);
                            streamingData.textElement.appendChild(textDiv);
                        } else if (part.type === 'code') {
                            const codeBlock = this.createCodeBlock(part.code, part.language);
                            streamingData.textElement.appendChild(codeBlock);
                        }
                    });
                    
                    // –î–æ–±–∞–≤–ª—è–µ–º –∫–Ω–æ–ø–∫–∏ –æ–∑–≤—É—á–∫–∏
                    this.addVoiceControls(streamingData.element, fullText);
                    
                    this.updateConversationHistory('assistant', fullText);
                    
                    // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ–∑–≤—É—á–∏–≤–∞–µ–º –æ—Ç–≤–µ—Ç
                    if (this.state.voiceSettings.enabled) {
                        this.speakText(fullText);
                    }
                }
            }

            addVoiceControls(messageElement, text) {
                if (!this.state.speechSynthesis) return;
                
                const controlsDiv = document.createElement('div');
                controlsDiv.className = 'voice-controls';
                
                const speakButton = document.createElement('button');
                speakButton.className = 'voice-btn';
                speakButton.dataset.action = 'speak';
                speakButton.innerHTML = '<i class="fas fa-volume-up"></i> –û–∑–≤—É—á–∏—Ç—å';
                speakButton.title = '–û–∑–≤—É—á–∏—Ç—å –æ—Ç–≤–µ—Ç';
                
                const stopButton = document.createElement('button');
                stopButton.className = 'voice-btn';
                stopButton.dataset.action = 'stop';
                stopButton.innerHTML = '<i class="fas fa-stop"></i> –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å';
                stopButton.title = '–û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –æ–∑–≤—É—á–∫—É';
                stopButton.disabled = !this.state.isSpeaking;
                
                const toggleButton = document.createElement('button');
                toggleButton.className = `voice-btn ${this.state.voiceSettings.enabled ? 'active' : ''}`;
                toggleButton.dataset.action = 'toggle';
                toggleButton.innerHTML = this.state.voiceSettings.enabled ? 
                    '<i class="fas fa-bell-slash"></i> –í—ã–∫–ª. –∑–≤—É–∫' : 
                    '<i class="fas fa-bell"></i> –í–∫–ª. –∑–≤—É–∫';
                toggleButton.title = '–í–∫–ª—é—á–∏—Ç—å/–≤—ã–∫–ª—é—á–∏—Ç—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫—É—é –æ–∑–≤—É—á–∫—É';
                
                controlsDiv.appendChild(speakButton);
                controlsDiv.appendChild(stopButton);
                controlsDiv.appendChild(toggleButton);
                
                // –í—Å—Ç–∞–≤–ª—è–µ–º –∫–Ω–æ–ø–∫–∏ –ø–æ—Å–ª–µ —Ç–µ–∫—Å—Ç–∞ —Å–æ–æ–±—â–µ–Ω–∏—è
                const messageTime = messageElement.querySelector('.message-time');
                if (messageTime) {
                    messageElement.insertBefore(controlsDiv, messageTime);
                } else {
                    messageElement.appendChild(controlsDiv);
                }
            }

            addUserMessage(text, saveToHistory = true) {
                const messageDiv = document.createElement('div');
                messageDiv.className = 'message user-message';
                messageDiv.innerHTML = `
                    <div class="message-text">${this.escapeHtml(text)}</div>
                    <div class="message-time">${this.getCurrentTime()}</div>
                `;
                
                this.elements.chatMessages.appendChild(messageDiv);
                this.scrollToBottom();
                this.state.messageCount++;
                
                if (saveToHistory) {
                    this.updateConversationHistory('user', text);
                }
            }

            addBotMessage(text, langConfig, saveToHistory = true) {
                const messageDiv = document.createElement('div');
                messageDiv.className = 'message bot-message';
                
                const messageText = document.createElement('div');
                messageText.className = 'message-text';
                
                const processedParts = this.processAIResponse(text);
                processedParts.forEach(part => {
                    if (part.type === 'text') {
                        const textDiv = document.createElement('div');
                        textDiv.innerHTML = this.formatText(part.content);
                        messageText.appendChild(textDiv);
                    } else if (part.type === 'code') {
                        const codeBlock = this.createCodeBlock(part.code, part.language);
                        messageText.appendChild(codeBlock);
                    }
                });
                
                const messageTime = document.createElement('div');
                messageTime.className = 'message-time';
                messageTime.textContent = this.getCurrentTime();
                
                messageDiv.appendChild(messageText);
                messageDiv.appendChild(messageTime);
                
                // –î–æ–±–∞–≤–ª—è–µ–º –∫–Ω–æ–ø–∫–∏ –æ–∑–≤—É—á–∫–∏
                this.addVoiceControls(messageDiv, text);
                
                this.elements.chatMessages.appendChild(messageDiv);
                this.scrollToBottom();
                
                if (saveToHistory) {
                    this.updateConversationHistory('assistant', text);
                }
                
                // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ–∑–≤—É—á–∏–≤–∞–µ–º –æ—Ç–≤–µ—Ç
                if (this.state.voiceSettings.enabled) {
                    this.speakText(text);
                }
            }

            updateConversationHistory(role, content) {
                this.state.conversationHistory.push({ role, content });
                
                if (this.state.conversationHistory.length > this.config.features.messageHistory) {
                    this.state.conversationHistory = this.state.conversationHistory.slice(-this.config.features.messageHistory);
                }
            }

            showSystemMessage(text, type = 'info') {
                const messageDiv = document.createElement('div');
                messageDiv.className = `message bot-message ${type}-message`;
                messageDiv.innerHTML = `
                    <div class="message-text">${this.escapeHtml(text)}</div>
                    <div class="message-time">${this.getCurrentTime()}</div>
                `;
                
                this.elements.chatMessages.appendChild(messageDiv);
                this.scrollToBottom();
            }

            setUIState(enabled) {
                const langConfig = this.languages[this.state.currentLanguage];
                
                this.elements.sendButton.disabled = !enabled || !this.state.isOnline;
                this.elements.messageInput.disabled = !enabled || !this.state.isOnline;
                this.elements.messageInput.placeholder = enabled && this.state.isOnline
                    ? langConfig.ui.inputPlaceholder
                    : this.state.isOnline 
                        ? langConfig.ui.status.streaming
                        : langConfig.ui.messages.noConnection;
                
                if (enabled && this.state.isOnline) {
                    this.elements.messageInput.focus();
                }
            }

            stopStreaming() {
                this.state.isStreaming = false;
                const langConfig = this.languages[this.state.currentLanguage];
                this.updateStatus('online', langConfig.ui.status.online);
                this.setUIState(true);
            }

            scrollToBottom() {
                requestAnimationFrame(() => {
                    this.elements.chatMessages.scrollTop = this.elements.chatMessages.scrollHeight;
                });
            }

            getCurrentTime() {
                return new Date().toLocaleTimeString('ru-RU', {
                    hour: '2-digit',
                    minute: '2-digit'
                });
            }

            delay(ms) {
                return new Promise(resolve => setTimeout(resolve, ms));
            }

            escapeHtml(text) {
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            }
        }

        window.addEventListener('beforeunload', () => {
            if (window.atomChat) {
                window.atomChat.stopSpeaking();
                if (window.atomChat.state.isStreaming) {
                    window.atomChat.stopStreaming();
                }
            }
        });

        document.addEventListener('DOMContentLoaded', () => {
            window.atomChat = new AtomChat();
        });

        if (!AbortSignal.timeout) {
            AbortSignal.timeout = function(ms) {
                const controller = new AbortController();
                setTimeout(() => controller.abort(), ms);
                return controller.signal;
            };
        }
    </script>
</body>
</html>